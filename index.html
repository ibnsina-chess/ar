<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فرسان الظلام ابن سينا - نادي الشطرنج</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="https://i.ibb.co/Vwt7cPq/the-dark-knights-ibns-sina-chess-club-logo-1.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    html{
        scrollbar-width: none;
    }
    .main img{
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin: 20px;
     
    }
    .about{
        background: black;
        color: white;
        padding: 10px;
        margin: 10px;
        border-radius: 20px;
        margin-bottom: 30px;
    }
    .about-p {
        color: white;
        font-size: 1.2rem;
        line-height: 1.6;
        margin-top: 1rem;
    }
    
    .activities {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin: 20px;
        gap: 15px;
    }
    .activity-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: white;
     
        width: 25%;
       height: 600px;
       border: solid 1px black;
        border-radius: 20px;
        transition: all 0.3s ease;
      
    }
    .activity-card i {
        margin-top: 10px;
        padding: 5px;
        font-size: 30px;
        border-radius: 20px;

    }
    .activity-card:hover{
        background: black;
        color: white;
        transition: all 0.3s ease;

    }
    .activity-card:hover img{
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    .activity-card:hover i{
        
        padding: 10px;
        margin-bottom: 10px;
        background: white;
        color: black;
        border-radius: 100px;
        transition: all 0.3s ease;
    }

    .activity-card img {
        transition: all 0.3s ease;
  border-radius: 15px;
        width: 250px;
        height: 250px;
        
    }

    .activity-card p , .activity-card h3{
        padding: 10px;
        font-size: 17px;
    }
   
    /* New styles for top players section */
    .top-players-container {
        margin: 30px 10px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .top-players-title {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.8rem;
        color: #000;
    }
    
    .top-players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .player-card {
        background: #f8f8f8;
        border-radius: 15px;
        padding: 15px;
        display: flex;
        align-items: center;
        border: 1px solid #eee;
        transition: transform 0.3s ease;
    }
    
    .player-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .player-rank {
        font-size: 1.8rem;
        font-weight: bold;
        margin-right: 15px;
        min-width: 30px;
        text-align: center;
    }
    
    .rank-1 {
        color: gold;
    }
    
    .rank-2 {
        color: silver;
    }
    
    .rank-3 {
        color: #cd7f32;
    }
    
    .player-info {
        flex-grow: 1;
    }
    
    .player-name {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 5px;
    }
    
    .player-rating {
        font-size: 1rem;
        color: #555;
    }
    
    .player-trend {
        display: flex;
        align-items: center;
        margin-left: 10px;
    }
    
    .trend-up {
        color: green;
    }
    
    .trend-down {
        color: red;
    }
    
    .trend-neutral {
        color: gray;
    }
    
    /* Evolution chart styles */
    .evolution-chart-container {
        margin: 30px 10px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 1.8rem;
        color: #000;
    }
    
    .chart-category-selector {
        padding: 8px 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        background: #f8f8f8;
        cursor: pointer;
        font-size: 1rem;
    }
    
    .chart-container {
        height: 400px;
        position: relative;
    }
    
    .last-update {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        margin-top: 10px;
        font-style: italic;
    }

    .language-switch {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
}

.lang-btn {
    display: flex;
    align-items: center;
    background-color: #000;
    color: #fff;
    padding: 8px 15px;
    border-radius: 20px;
    text-decoration: none;
    font-size: 16px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.lang-btn i {
    margin-right: 8px;
    font-size: 18px;
}

.lang-btn:hover {
    background-color: #333;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

@media screen and (max-width: 600px) {
    .language-switch {
        top: 10px;
        left: 10px;
    }
    
    .lang-btn {
        padding: 6px 12px;
        font-size: 14px;
    }
}
    @media screen and (max-width: 600px) {
        
        .about-p{
            font-size: 17px;
            height: 200px;
            overflow-y: scroll;
            scrollbar-width: none; 

        }
        .activity-card {
            width: 100%;
        }
        
        .top-players-grid {
            grid-template-columns: 1fr;
        }
        
        .player-card {
            padding: 10px;
        }
        
        .chart-header {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
</head>
<body>
    <nav>
        <img src="https://i.ibb.co/Vwt7cPq/the-dark-knights-ibns-sina-chess-club-logo-1.png" alt="" class="logo">

        <div class="menu-toggle" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div class="language-switch">
            <a href="/en" class="lang-btn">English <i class="fa-solid fa-language"></i></a>
        </div>

        <ul>
            <li><a href="index.html">الرئيسية</a></li>
            <li><a href="members.html">الأعضاء</a></li>
            <li><a href="classification.html">التصنيف</a></li>
            <li><a href="evolution.html">التطور</a></li>
            <li><a href="puzzles.html">ألغاز</a></li>
    
        </ul>
    </nav>
    
    <div class="main">
        <img  src="https://i.ibb.co/Vwt7cPq/the-dark-knights-ibns-sina-chess-club-logo-1.png" alt="">
        <h1 class="greeting-p">مرحبًا بالجميع في نادي الشطرنج الخاص بنا<br><span>فرسان الظلام ابن سينا</span></h1>
    </div>

    <!-- Evolution Chart Section -->
    <div class="evolution-chart-container">
        <div class="chart-header">
            <h2 class="chart-title">تطور التصنيف</h2>
            <select class="chart-category-selector" id="categorySelector">
                <option value="chess_rapid">تصنيف سريع</option>
                <option value="chess_blitz">تصنيف خاطف</option>
                <option value="chess_bullet">تصنيف سريع جدًا</option>
                <option value="chess_daily">تصنيف يومي</option>
                <option value="tactics">تصنيف التكتيكات</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="evolutionChart"></canvas>
        </div>
        <p class="last-update" id="lastUpdate">آخر تحديث: جارٍ التحميل...</p>
    </div>
    


       <!-- Top Players Section -->
       <div class="top-players-container">
        <h2 class="top-players-title">أفضل اللاعبين</h2>
        <div class="top-players-grid" id="topPlayersGrid">
            <p class="loading-text">جارٍ تحميل بيانات أفضل اللاعبين...</p>
        </div>
    </div>
    
    

    <div class="about" >
        <h2>من نحن</h2>
        <p class="about-p">
            فرسان الظلام ابن سينا هو نادي الشطرنج الرسمي لثانوية ابن سينا، مكرس لتعزيز شغف الشطرنج بين الطلاب. تأسس النادي في عام 2024 بواسطة أحمد اليعقوبي، الذي يعمل أيضًا كمدرب لنا، ويوفر النادي منصة للطلاب من جميع مستويات المهارة للتجمع وتحسين تفكيرهم الاستراتيجي، وقدراتهم على حل المشكلات، ومهارات الشطرنج العامة. يسعى النادي إلى خلق بيئة داعمة وتنافسية، واستضافة جلسات تدريب منتظمة، وبطولات، ومباريات ودية. مهمتنا ليست فقط التفوق في لعبة الشطرنج ولكن أيضًا بناء إحساس قوي بالمجتمع والانضباط والعمل الجماعي بين أعضائنا. سواء كنت مبتدئًا أو لاعبًا متقدمًا، فإن فرسان الظلام ابن سينا يرحب بك للانضمام إلينا وأن تكون جزءًا من عائلة الشطرنج المتنامية في ثانوية ابن سينا.
        </p>
    </div>
    
 
    <h2>الأنشطة</h2>

    <div class="activities">

        <div class="activity-card">
            <i class="fa-solid fa-dumbbell"></i>
            <img src="https://i.ibb.co/Gf8dwMJ6/Chess.png" alt="">
            <h3>جلسات تدريب أسبوعية</h3>
            <p>انضم إلينا كل يوم اثنين وجمعة لجلسات تدريب حيث يمكنك تعلم استراتيجيات جديدة، وتحسين مهاراتك، ولعب مباريات ودية مع أعضاء آخرين.</p>
        </div>
        <div class="activity-card">
            <i class="fa-solid fa-trophy"></i>
            <img src="https://i.ibb.co/6cQ75xrR/Chess-1.png" alt="">
            <h3>بطولات شهرية</h3>
            <p>شارك في بطولاتنا الشهرية لاختبار مهاراتك، والتنافس ضد أعضاء آخرين، والفوز بجوائز مثيرة.</p>
   
        </div>
        <div class="activity-card">
            <i class="fa-solid fa-pen-to-square"></i>
            <img src="https://i.ibb.co/TB25nKgR/Chess-2.png" alt="">
            <h3>مدونة الشطرنج</h3>
            <p>ابق على اطلاع بآخر الأخبار والاستراتيجيات والنصائح في عالم الشطرنج. تضم مدونتنا مقالات من لاعبين ذوي خبرة، وأحداث قادمة، ورؤى لمساعدتك على تحسين لعبتك.</p>
        </div>
    </div>
    
    <footer>
       <div class="horizontal-div">
            <img src="https://i.ibb.co/xr0mz7L/buil-by.png" alt="">
           
            <a href="https://github.com/abdelhakim-sahifa"> <i class="fa-brands fa-github"></i></a>
       </div>


          <ul class="footer-links">
            <li><a href="index.html">الرئيسية</a></li>
            <li><a href="members.html">الأعضاء</a></li>
            <li><a href="classification.html">التصنيف</a></li>
            <li><a href="evolution.html">التطور</a></li>
            <li><a href="puzzles.html">الألغاز</a></li>
        </ul>
        <p>&copy; 2024 فرسان الظلام ابن سينا. جميع الحقوق محفوظة.</p>

            
   </footer>

    <script>
        function toggleMenu() {
            const navLinks = document.querySelector("nav ul");
            navLinks.classList.toggle("show");
        }
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd9XbhKz-AYvVJtLCi2hVDBvyYsSGB89w",
            authDomain: "chess-3596b.firebaseapp.com",
            databaseURL: "https://chess-3596b-default-rtdb.firebaseio.com",
            projectId: "chess-3596b",
            storageBucket: "chess-3596b.appspot.com",
            messagingSenderId: "628293480183",
            appId: "1:628293480183:web:ecd5f317c728cd1233edf2",
            measurementId: "G-11H7GE4LT7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Categories for chess ratings
        const chessCategories = [
            { id: "chess_rapid", title: "تصنيف الشطرنج السريع" },
            { id: "chess_blitz", title: "تصنيف الشطرنج الخاطف" },
            { id: "chess_bullet", title: "تصنيف الشطرنج السريع جدًا" },
            { id: "chess_daily", title: "تصنيف الشطرنج اليومي" },
            { id: "tactics", title: "أعلى تصنيف للتكتيكات" }
        ];

        // Get saved ratings and last visit timestamp from localStorage
        const savedRatings = JSON.parse(localStorage.getItem('playerRatings')) || {};
        const lastVisit = localStorage.getItem('lastVisit');
        
        // Update the last update text
        if (lastVisit) {
            document.getElementById('lastUpdate').textContent = `آخر تحديث: ${lastVisit}`;
        } else {
            document.getElementById('lastUpdate').textContent = 'هذه زيارتك الأولى. ستتوفر البيانات بعد زيارتك التالية.';
        }
        
        // Update the last visit timestamp
        localStorage.setItem('lastVisit', new Date().toLocaleString());
        
        // Save updated ratings to localStorage
        const saveRatingsToLocalStorage = (ratings) => {
            localStorage.setItem('playerRatings', JSON.stringify(ratings));
        };
        
        // Load members data
        const memberRef = ref(database, 'members/');
        const topPlayersGrid = document.getElementById('topPlayersGrid');
        const categorySelector = document.getElementById('categorySelector');
        let evolutionChart;
        
        // Get the top players data and create the evolution chart
        onValue(memberRef, async (snapshot) => {
            const members = snapshot.val();
            const memberKeys = Object.keys(members);
            const categoryDataMap = {};
            const newRatings = {};
            
            // Initialize data structure for each category
            chessCategories.forEach(category => {
                categoryDataMap[category.id] = [];
            });
            
            // Process each member
            let counter = 0;
            for (const key of memberKeys) {
                const memberRef = ref(database, `members/${key}`);
                
                await new Promise((resolve) => {
                    onValue(memberRef, async (snapshot) => {
                        counter++;
                        
                        const memberData = snapshot.val();
                        const username = memberData.username;
                        
                        if (username && username !== "none") {
                            try {
                                const response = await fetch(`https://api.chess.com/pub/player/${username}/stats`);
                                if (response.ok) {
                                    const data = await response.json();
                                    
                                    chessCategories.forEach(category => {
                                        const categoryData = data[category.id]?.last || data[category.id]?.highest || null;
                                        if (categoryData) {
                                            const currentRating = categoryData.rating || 0;
                                            const playerName = memberData.name;
                                            
                                            // Get saved rating and calculate evolution
                                            const savedRating = savedRatings[playerName]?.[category.id] || 0;
                                            const evolution = currentRating - savedRating;
                                            
                                            // Store current rating in the new ratings object
                                            if (!newRatings[playerName]) newRatings[playerName] = {};
                                            newRatings[playerName][category.id] = currentRating;
                                            
                                            categoryDataMap[category.id].push({
                                                name: playerName,
                                                rating: currentRating,
                                                evolution: evolution
                                            });
                                        }
                                    });
                                }
                            } catch (error) {
                                console.error(`Failed to fetch stats for username: ${username}`, error);
                            }
                        }
                        resolve();
                    }, { onlyOnce: true });
                });
            }
            
            // Save updated ratings to localStorage
            saveRatingsToLocalStorage(newRatings);
            
            // Display top players (using rapid rating by default)
            displayTopPlayers('chess_rapid');
            
            // Create the evolution chart for the default selected category
            createEvolutionChart('chess_rapid');
            
            // Add event listener for category change
            categorySelector.addEventListener('change', function() {
                displayTopPlayers(this.value);
                createEvolutionChart(this.value);
            });
            
            // Function to display top players for a specific category
            function displayTopPlayers(categoryId) {
                const data = categoryDataMap[categoryId];
                if (!data || data.length === 0) {
                    topPlayersGrid.innerHTML = '<p>لا توجد بيانات متاحة لهذه الفئة.</p>';
                    return;
                }
                
                data.sort((a, b) => b.rating - a.rating);
                topPlayersGrid.innerHTML = '';
                
                // Display only top 6 players
                const topPlayers = data.slice(0, 6);
                
                topPlayers.forEach((player, index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    
                    let trendIcon = '';
                    let trendClass = '';
                    
                    if (player.evolution > 0) {
                        trendIcon = '<i class="fas fa-caret-up"></i>';
                        trendClass = 'trend-up';
                    } else if (player.evolution < 0) {
                        trendIcon = '<i class="fas fa-caret-down"></i>';
                        trendClass = 'trend-down';
                    } else {
                        trendIcon = '<i class="fas fa-minus"></i>';
                        trendClass = 'trend-neutral';
                    }
                    
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    playerCard.innerHTML = `
                        <div class="player-rank ${rankClass}">${rank}</div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-rating">التصنيف: ${player.rating}</div>
                        </div>
                        <div class="player-trend ${trendClass}">
                            ${trendIcon} ${player.evolution > 0 ? '+' : ''}${player.evolution}
                        </div>
                    `;
                    
                    topPlayersGrid.appendChild(playerCard);
                });
            }
            
            // Function to create the evolution chart
            function createEvolutionChart(categoryId) {
                const data = categoryDataMap[categoryId];
                if (!data || data.length === 0) return;
                
                data.sort((a, b) => b.rating - a.rating);
                
                // Get top 5 players for the chart
                const topPlayers = data.slice(0, 5);
                
                const chartLabels = topPlayers.map(player => player.name);
                const currentRatings = topPlayers.map(player => player.rating);
                const previousRatings = topPlayers.map(player => player.rating - player.evolution);
                
                const ctx = document.getElementById('evolutionChart').getContext('2d');
                
                // Destroy previous chart instance if it exists
                if (evolutionChart) evolutionChart.destroy();
                
                evolutionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: 'التصنيف السابق',
                                data: previousRatings,
                                backgroundColor: 'rgba(169, 169, 169, 0.7)',
                                borderColor: 'rgba(169, 169, 169, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'التصنيف الحالي',
                                data: currentRatings,
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                borderColor: 'rgba(0, 0, 0, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'التصنيف'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'اللاعبون'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `أفضل 5 لاعبين - ${chessCategories.find(cat => cat.id === categoryId).title}`,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const playerIndex = context.dataIndex;
                                        const playerEvolution = topPlayers[playerIndex].evolution;
                                        const sign = playerEvolution > 0 ? '+' : '';
                                        return `التطور: ${sign}${playerEvolution}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script> 
</body>
</html>